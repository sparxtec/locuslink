# This workflow will Deploy an image pulled from the GHCR, using a build number input by the user

name: Deploy Docker Image - AWS Dev

on: 
  workflow_dispatch:
    inputs:
      version:
        description: Input the Build Run Number to deploy
        default: 2.dev
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  
  
  AWS_REGION: ap-south-1                   
  ECR_REPOSITORY: demo-repo        
  ECS_SERVICE: demo-service               
  ECS_CLUSTER: demo-ecs-cluster              
  ECS_TASK_DEFINITION: .aws/td.json 
  CONTAINER_NAME: nginx
  
jobs:

 deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3      

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
          
    - name: Pull the Docker Image
      run: |      
        IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME
        
        # Change all uppercase to lowercase
        IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
        
        # Strip git ref prefix from version
        #VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          
        # Strip "v" prefix from tag name
        #[[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
        
        # Use Docker `latest` tag convention
        #[ "$VERSION" == "master" ] && VERSION=latest
        
        echo IMAGE_ID=$IMAGE_ID        
        echo VERSION=$VERSION
        echo BUILD_ID=${GITHUB_RUN_ID}
        echo BUILD_NBR=${GITHUB_RUN_NUMBER}
   
        #docker tag $IMAGE_NAME $IMAGE_ID:${GITHUB_RUN_NUMBER}.$VERSION

        #docker push $IMAGE_ID:${GITHUB_RUN_NUMBER}.$VERSION
          
        docker pull $IMAGE_ID:2.dev
