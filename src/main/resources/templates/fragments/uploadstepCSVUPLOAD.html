<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>CSV Upload Docs</title>

<!-- StyleSheets - ORDER IS IMPORTANT -->
<link href="css/de-upload-styles.css" rel="stylesheet">

<script>		
		var stepper1 = null;		
		
		//Dropzone.autoDiscover = true;
		
		$('#tracedropzone').dropzone({
			
			   headers:{   'X-CSRFToken' : '{{ csrf_token }}' },
			
			   acceptedFiles: '.csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
			 			 		
			   maxThumbnailFilesize: '15',
			   dictInvalidFileType: "Incorrect File type, please upload only xls files",
			    
	 		   init: function() {
	 		     this.on("addedfile", 
	 		    	function(file) {	
	 		    	 	 		    	 
	 		            var preview = document.getElementsByClassName('dz-preview');
	 		            preview = preview[preview.length - 1];

	 		            var imageName = document.createElement('span');
	 		            imageName.innerHTML = file.name;

	 		            preview.insertBefore(imageName, preview.firstChild);	 		  
	 		    	 
	 		      });
	 		     
	 		     this.on("success", 
	 		    	function(file) {
	 		    	 
	 		    	  $(".dz-success-mark svg").css("background", "green");
	 		    	  $(".dz-error-mark").css("display", "none");
	 		    	 
	 		    		document.getElementById("continueGoToPage3_NEW").disabled = false;	 		    		    
	 		      }); 		     		  
	 		
	 	     	this.on("error", 
	 		    	function(file) {	
	 	     		
	 	     		 $(".dz-error-mark svg").css("background", "red");
	 	     		  $(".dz-success-mark").css("display", "none");	 	     		  
	 	     		  
	 		      }); 		
	 	     	
	 	     	this.on("removedfile", 
	 	     		function(file) {
	 	         		var myData = {version:"1.0", protocol:"json", clientId:"trace"};
	 	               	var innerData = {};
	 	        		innerData["fileName"] = file.name;
	 	        		innerData["userName"] = "TSpecte";
	 	        		myData["data"] = innerData;

	 	        		submitFormAjaxJSON("deleteFileUpload", myData, "deleteFileUploadResponse");
	 	        		if (this.files[0] == null) {
			 		    	
			 		   		document.getElementById("continueGoToPage3_NEW").disabled = true;
			 		    }
	 	     		});		   
	 		   }
	 		
	 		}); 
	         	
		
		//$('#tracedropzone').addClass("dropzone");
			
	
		$(document).ready(function() {	
			window.addEventListener("dragover",function(e){
				  e = e || event;
				  e.preventDefault();
				},false);
				window.addEventListener("drop",function(e){
				  e = e || event;
				  e.preventDefault();
				},false);
			
			document.getElementById("continueGoToPage3_NEW").disabled = true;
			
			
			$('#continueGoToPage3_NEW').click(function() {													
				showSpinner();	

				var myData = {version:"1.0", protocol:"json", clientId:"trace",action:"initial"};
 	            var innerData = {};	        	
 	        	myData["data"] = getAllCsvFiles(); 
	        	
	        	console.log("Selected Doc Type"+JSON.stringify(myData));    
	        	
         submitFormAjaxJSON("saveCsvRecord",myData, "csvUpload");
        						
			});
			
		
			
			$('#startOver').click(function() {	
				console.log("calling csvUpload")
				showSpinner();			
				submitFormAjaxHTML('initCsvUpload', $( "#docUploadFormDTO" ).serialize(), "initCommonResponse");
				$('.is-current').removeClass('is-current');
				$('#csvUploadHeaderId').addClass('is-current');
				$(this).addClass('is-current');
			});
			
			$('#dupOptionOverwriteOverride').click(function() {	
				
				showSpinner();		
				var myData = {version:"1.0", protocol:"json", clientId:"trace",action:"overwrite"};
 	            var innerData = {};	        	
 	        	myData["data"] = getAllCsvFiles(); 
				submitFormAjaxJSON("saveCsvRecord", myData, "callStepper");
			});
			
			$('#dupOptionOverwriteSkip').click(function() {	
				console.log("dupOptionOverwriteSkip ..."+JSON.stringify(myData))
				showSpinner();		
				var myData = {version:"1.0", protocol:"json", clientId:"trace",action:"skip"};
			    var innerData = {};	        	
			 	myData["data"] = getAllCsvFiles();
							
				console.log("dupOptionOverwriteSkip ..."+JSON.stringify(myData))
				submitFormAjaxJSON("saveCsvRecord", myData, "callStepper");
			});
			

		     stepper1 = new Stepper($('.bs-stepper')[0], {
		        linear: true
		      }); 

		   //stepper2.to(4);
	
		    $(".dz-message").html('<button type="button" class="button button--secondary mb-4" style="min-width: 20rem;">Click to browse files</button><p>Each file must be less than 15MB and a ".csv" file.</p>');		    		    	
			hideSpinner();				    
		   // $('#stepper2').addClass("is-current");
		    									
		});
		
	function getAllCsvFiles(){
		var fileNames = []
		$('.dz-filename').each(function(){
			  console.log( $(this).text() );
			  fileNames.push( $(this).text() );
			});
		return fileNames;
	}
			
		function initCommonResponse(returnData) {	
			hideSpinner();
			$('#mainBody').html( returnData); 	 
		}
		
		function commonResponse(returnData) {		
			hideSpinner();
			$('#mainBody').html( returnData); 	 
		}
		
		 function csvUpload(returnData) {
			 //console.log("Return datta"+ JSON.stringify(returnData));
			 
			 //console.log("Return datta"+ returnData.data.fileExist);
			 var f= getAllCsvFiles();
			 console.log("FILES LIST :: "+f);
			  if(returnData.data.fileExist === true){
    				$("#dupOptionOverwrite").modal('show');
    				hideSpinner();
    				return;
    			} 
			hideSpinner();
		    callStepper();
		}

		function callStepper() {
		console.log("Calling steeper");

		$("#step1").hide();
		$("#step2").show();
		hideSpinner();
		}
</script>

</head>


<body>


	<section class="de-component h-100">
		<div class="de-component__container">
			<header class="de-component-header mb-0">
				<h2 class="de-component-header__title">Upload Docs</h2>
			</header>

			<div id="stepper1" class="bs-stepper">
				<div class="bs-stepper-header m-auto bs-stepper-custom-width"
					role="tablist"></div>

				<div class="bs-stepper-content">



					<div id="step1" role="tabpanel" class="content active" 	aria-labelledby="stepper1trigger2">
					
						<div class="form-group text-center bs-stepper-custom-width m-auto">

							<form id="tracedropzone" name="tracedropzone"
							
								action="/portal/processCsvFileUpload" class="dropzone dz-clickable"enctype="multipart/form-data" method="POST">								
								
										     <!-- CSRF token -->
			 <input type="hidden" th:name="${_csrf.parameterName}"   th:value="${_csrf.token}"/>
			 
								<div>
									<input type="hidden" id="purchaseOrderNumber" name="purchaseOrderNumber" th:value="${purchaseOrderNumber}">

									<!-- CS 5-14-2020 -->
								 <input type="hidden" id="itemNumber" name="itemNumber" 	th:value="${itemNumber}">

								</div>
								<div class="dz-default dz-message">
									<span>Files must be less than 15MB and a '.xls' file</span>
								</div>
							</form>
						</div>
						<div
							class="py-4 text-center px-0 d-flex justify-content-between d-sm-block">
							<button type="button" id="continueGoToPage3_NEW"
								class="button button--continue ml-3" onclick="" disabled>Upload</button>

						</div>
					</div>



					<div id="step2" role="tabpanel" class="content"
						aria-labelledby="stepper1trigger3">
						<div
							class="form-group text-center bs-stepper-custom-width m-auto d-flex flex-column">
							<div
								class="alert alert-dismissible fade hidden de-alert de-alert-success de-alert-impact fixed-top text-left align-items-center d-none"
								role="alert">
								<span><strong>Congrats!</strong> You have successfully
									corrected unparsed documents. <a href="#" data-dismiss="alert"
									class="button button--text" onclick="stepper1.reset();">Upload
										more documents</a></span>
								<button type="button" class="close" data-dismiss="alert"
									aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<i class="far fa-check-circle text-success"
								style="font-size: 7rem;"></i> <span class="de-h4">Congratulations!</span>
							<span>You have successfully uploaded the file.</span>
						</div>
						<div class="py-4 text-center px-0 d-flex justify-content-center">
							<button type="button" class="button button--submit ml-3"
								id="startOver">Start Over</button>
						</div>
					</div>


				</div>
			</div>

		</div>
	</section>
	
	
	<!--  overwrite modal -->
<!-- 	<div class="modal fade alert-blocker" id="dupOptionOverwrite"
		tabindex="-1" role="dialog" aria-labelledby="dupOptionOverwriteModal"
		aria-hidden="true" style="display: none">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-body text-left">
					<h5 class="de-h5">Documents Already Uploaded</h5>
					<p>The documents that you have submitted match documents that
						have already been uploaded.Click 'Dismiss' to stay and make
						changes or Click 'Overwrite' to save over the current set of
						documents and lose all changes.</p>
					<ol type="1" id="duplicatesCanOverride"
						style="word-break: break-all">
					</ol>
				</div>
				<div class="modal-footer">
					<button type="button" id="dupOptionOverwriteDismiss"
						class="button button--small button--text px-0 mx-5"
						style="width: 7rem" data-dismiss="modal">Dismiss</button>
					<button type="button" class="button button--secondary "
						id="dupOptionOverwriteSkip" data-dismiss="modal"
						style="width: 15rem">Skip Duplicates</button>
					<button type="button" class="button button--primary "
						id="dupOptionOverwriteOverride" data-dismiss="modal"
						style="width: 15rem">Overwrite</button>
				</div>
			</div>
		</div>
	</div> -->
</body>

</html>